---
title: "Webscraping Commsec"
author: "KevinHo"
date: "15 February 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## About

This is my first exercise in webscraping
I'm following the tutorial listed [here](https://blog.rstudio.org/2014/11/24/rvest-easy-web-scraping-with-r/).
And the CRAN repository is [here](https://cran.r-project.org/web/packages/rvest/index.html)

## Setup



yahoo finance time series

```{r}
#######################################################################
##Alternate method to download all key stats using XML and x_path – PREFERRED WAY
#######################################################################


require(XML)
require(plyr)
getKeyStats_xpath <- function(symbol) {
  yahoo.URL <- "http://finance.yahoo.com/q/ks?s="
  html_text <- htmlParse(paste(yahoo.URL, symbol, sep = ""), encoding="UTF-8")

  #search for <td> nodes anywhere that have class ‘yfnc_tablehead1’
  nodes <- getNodeSet(html_text, "/*//td[@class='yfnc_tablehtthead1']")
  
  if(length(nodes) > 0 ) {
   measures <- sapply(nodes, xmlValue)
   
   #Clean up the column name
   measures <- gsub(" *[0-9]*:", "", gsub(" \\(.*?\\)[0-9]*:","", measures))   
   
   #Remove dups
   dups <- which(duplicated(measures))
   #print(dups) 
   for(i in 1:length(dups)) 
     measures[dups[i]] = paste(measures[dups[i]], i, sep=" ")
   
   #use siblings function to get value
   values <- sapply(nodes, function(x)  xmlValue(getSibling(x)))
   
   df <- data.frame(t(values))
   colnames(df) <- measures
   return(df)
  }
}

tickers <- c("AAPL")
stats <- ldply(tickers, getKeyStats_xpath)
rownames(stats) <- tickers
write.csv(t(stats), "FinancialStats_updated.csv",row.names=TRUE)  
```




Lets try Rselenium without docker. Help from StackO - RESOLVED MOTHER FUCKER!

EDIT: I've now removed all instances of my username and password. Time to get to work

```{r}

#Install firefox
#Download geckodriver and unzip the exe here c:\bin\geckodriver
#Run the following in cmd >set PATH=%PATH%;C:\bin\geckodriver
#start Selenium server by opening a command prompt and then type
#cd ~YOUR_R_PATH~\library\RSelenium\bin
#Download selenium server into the above location http://www.seleniumhq.org/download/ 
#java -jar selenium-server-standalone-x.xx.x.jar
library(RSelenium)

remDr <- remoteDriver()
remDr$open()

remDr$navigate("https://www2.commsec.com.au/Public/HomePage/Login.aspx")


#send password and Enter - deprecated
passwd <- remDr$findElement(using = "id", value = "ctl00_cpContent_fakepassword")
passwd$clearElement()
passwd$sendKeysToElement(list(aPhrase, "\uE007"))
```

The following script is used once you've logged in.
```{r}
#ONCE LOGGED IN
#send stock search
source("helpers.R")
library(XML)
library(stringi)

stock <- remDr$findElement(using = "id", value ="ctl00_ucTopSearch_Input")
stock$clearElement()
stock$sendKeysToElement(list("MNY"))
Sys.sleep(1)
stock$sendKeysToElement(list("\uE007"))

#goto company research
compResearch <- remDr$findElement(using = 'css selector',".tab-inactive:nth-child(5) a")
Sys.sleep(1)
compResearch$clickElement()
Sys.sleep(1)

#goto financials
financials <- remDr$findElement(using = 'css selector',"#ctl00_BodyPlaceHolder_KeyMeasuresView1_ucCompanyProfilesHeader_hlFinancials")
Sys.sleep(1)
financials$clickElement()

#Convert Page to tables
doc <- htmlParse(remDr$getPageSource()[[1]])
tables <- readHTMLTable(doc, header = TRUE)

#clean the output
i=1
while(i < length(tables)+1) {
    names(tables[[i]]) <- stri_trim(stri_replace_all_fixed(names(tables[[i]]),"\n",""))
    
    i = i+1
    print(i)
}


rs <- record.new()

#Iterate over this


colnumber = 2
while (colnumber < dim(tables[[1]])[2]) {
    a <- data.frame("Company_Name" = "MNY",
            "Dividends" = tables[[1]][which(tables[[1]][,1] %in% "Dividends (cents)"),][colnumber],
            "Shares_Outstanding" = tables[[1]][which(tables[[1]][,1] %in% "Shares Outstanding (m)"),][colnumber],
            "Revenues"  = tables[[2]][which(tables[[2]][,1] %in% "Revenues (m)"),][colnumber],
            "Income_Tax_Rate" = tables[[2]][which(tables[[2]][,1] %in% "Income tax rate (%)"),][colnumber],
            "Net_Profit_Before_Abnormals" = tables[[2]][which(tables[[2]][,1] %in% "Net Profit Before Abnormals (m)"),][colnumber],
            "Net_Profit" = tables[[2]][which(tables[[2]][,1] %in% "Net Profit (m)"),][colnumber],
            "Long_term_debt" = tables[[2]][which(tables[[2]][,1] %in% "Long term debt (m)"),][colnumber],
            "Shareholders_Equity" = tables[[2]][which(tables[[2]][,1] %in% "Shareholders Equity (m)"),][colnumber],
            "EBITDA" = tables[[2]][which(tables[[2]][,1] %in% "EBITDA (m)"),][colnumber],
            "EBIT" = tables[[2]][which(tables[[2]][,1] %in% "EBIT (m)"),][colnumber],
            "Total_Current_Assets" = tables[[4]][which(tables[[4]][,1] %in% "Total Current Assets"),][2],
            "Total_Current Liabilities"= tables[[4]][which(tables[[4]][,1] %in% "Total Current Liabilities"),][2])
    rs<-cbind(rs,a)
    colnumber = colnumber +1
}

```

 
 